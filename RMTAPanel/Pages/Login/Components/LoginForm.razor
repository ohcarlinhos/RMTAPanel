@using Shared.Auth
@using RMTAPanel.Services
@using RMTAPanel.Utils

<MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
    <MudPaper Class="pa-4" Width="100%">
        <MudText Typo="Typo.h6" HtmlTag="h3">Acessar</MudText>

        <EditForm Model="@_loginDto" OnValidSubmit="@SubmitForm">
            <DataAnnotationsValidator/>

            <MudTextField
                @bind-Value="_loginDto.Email"
                Label="Email"
                InputType="InputType.Email"
                For="@(() => _loginDto.Email)"/>

            <MudTextField
                @bind-Value="_loginDto.Password"
                Label="Senha"
                InputType="InputType.Password"
                For="@(() => _loginDto.Password)"/>

            <MudStack Class="mt-2">
                <MudButton
                    Variant="Variant.Filled"
                    ButtonType="ButtonType.Submit"
                    Color="Color.Primary"
                    Disabled="_isFetch"
                    Class="mt-4">
                    @if (_isFetch)
                    {
                        <MudProgressCircular Indeterminate="true" Size="Size.Small"/>
                    }
                    else
                    {
                        @("Acessar");
                    }
                </MudButton>
            </MudStack>
        </EditForm>
    </MudPaper>
</MudStack>

@code {
    [Inject] HttpClient? Http { get; set; }
    [Inject] ISnackbar? Snackbar { get; set; }
    [Inject] ILocalStorageService? LocalStorage { get; set; }
    [Inject] CustomAuthStateProvider? AuthProvider { get; set; }
    [Inject] AuthenticateService? AuthService { get; set; }
    [Inject] HandleHttpErrorSnackbar? HandleHttpErrorSnackbar { get; set; }

    LoginDto _loginDto = new() { Email = "carlos@teste.com", Password = "SAklsaj)238al!" };
    private bool _isFetch;

    async Task SubmitForm()
    {
        try
        {
            _isFetch = true;
            var response = await Http!.PostAsJsonAsync("auth/login", _loginDto);
            
            if (await HandleHttpErrorSnackbar!.IsNotOk(response)) return;

            var content = await response.Content.ReadFromJsonAsync<JwtData>();
            if (content != null) await AuthService!.SetSate(content.Token);
        }
        catch (HttpRequestException e)
        {
            HandleHttpErrorSnackbar!.GeneralError(e);
        }
        finally
        {
            _isFetch = false;
        }
    }

}