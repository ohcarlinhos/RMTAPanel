@page "/users"
@using Shared.User
@using System.Net

<PageTitle>Usuários</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="py-20">
    <MudGrid>
        <MudItem sm="12">
            <MudText Typo="Typo.h4" HtmlTag="h2" Class="pb-4">Usuários</MudText>

            @if (_userList == null)
            {
                <MudText>Carregando...</MudText>
            }
            else if (_userList.Count > 0)
            {
                <MudTable Hover="true" Items="@_userList">
                    <HeaderContent>
                        <MudTh>Id</MudTh>
                        <MudTh>Nome</MudTh>
                        <MudTh>Email</MudTh>
                        <MudTh>Ativo</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd DataLabel="Id">@context.Id</MudTd>
                        <MudTd DataLabel="Nome">@context.Name</MudTd>
                        <MudTd DataLabel="Email">@context.Email</MudTd>
                        <MudTd DataLabel="Ativo">@(context.IsActive ? "Sim" : "Não")</MudTd>

                        <MudTd DataLabel="Ações">
                            <MudMenu Label="Ações" PositionAtCursor="true">
                                <MudMenuItem OnClick="() => EditUser(context)">Editar</MudMenuItem>
                                <MudMenuItem OnClick="() => EditPassword(context.Id)">Alterar senha</MudMenuItem>
                                <MudMenuItem OnClick="() => Disable(context)">Desativar</MudMenuItem>
                                @* <MudMenuItem OnClick="Delete">Apagar</MudMen uItem> *@
                            </MudMenu>
                        </MudTd>
                    </RowTemplate>

                    <PagerContent>
                        <MudTablePager/>
                    </PagerContent>
                </MudTable>
            }
            else
            {
                <MudPaper Class="pa-5">
                    <MudText>Nenhum usuário encontrado.</MudText>
                </MudPaper>
            }
        </MudItem>
    </MudGrid>
</MudContainer>


@code {
    [Inject] HttpClient? Http { get; set; }
    [Inject] IDialogService? DialogService { get; set; }
    [Inject] ISnackbar? Snackbar { get; set; }

    private List<UserMap>? _userList;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var response = await Http!.GetFromJsonAsync<Pagination<UserMap>>("user");
            if (response?.Data != null) _userList = response.Data;
        }
        catch (HttpRequestException e)
        {
            if (e.StatusCode == HttpStatusCode.Forbidden)
                Snackbar!.Add(ApiErrors.Forbidden, Severity.Error);
        }
    }

    private Task EditUser(UserMap user)
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            CloseOnEscapeKey = false,
            BackdropClick = false
        };

        var dialogParams = new DialogParameters
        {
            { "User", user }
        };

        return DialogService!.ShowAsync<EditUserModal>("Editar usuáiro", dialogParams, options);
    }

    private Task EditPassword(int id)
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            FullWidth = true,
            CloseOnEscapeKey = false,
            BackdropClick = false
        };

        var dialogParams = new DialogParameters<EditPasswordModal>
        {
            { "Id", id }
        };

        return DialogService!.ShowAsync<EditPasswordModal>("Alterar senha", dialogParams, options);
    }

    private Task Disable(UserMap user)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = false,
            BackdropClick = false,
            MaxWidth = MaxWidth.ExtraSmall
        };

        var dialogParams = new DialogParameters<DisableUserModal>
        {
            { "User", user }
        };

        return DialogService!.ShowAsync<DisableUserModal>("Desativar usuário", dialogParams, options);
    }

    // private Task Delete()
    // {
    //     var options = new DialogOptions
    //     {
    //         CloseOnEscapeKey = false, 
    //         BackdropClick = false,
    //         
    //     };
    //     
    //     return DialogService!.ShowAsync<DeletePasswordModal>("Apagar usuário", options);
    // }

}